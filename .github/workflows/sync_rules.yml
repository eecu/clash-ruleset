name: Sync Sukka Clash Rules

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Download and Convert Rules
        run: |
          BASE_URL="https://ruleset.skk.moe/Clash"
          
          # Ê∏ÖÁêÜÊóßÊñá‰ª∂
          rm -rf domainset non_ip ip yaml mrs
          mkdir -p domainset non_ip ip yaml/domainset yaml/non_ip yaml/ip mrs/domainset mrs/non_ip mrs/ip
          
          # Ëé∑ÂèñËßÑÂàôÂàóË°®
          echo "üì• Fetching rule list..."
          curl -s https://ruleset.skk.moe/ | grep -oP 'Clash/(domainset|non_ip|ip)/[^"]+\.txt' | sort -u > rules_list.txt
          
          # ‰∏ãËΩΩÊâÄÊúâËßÑÂàô
          echo "üì• Downloading rules..."
          while read -r rule; do
            url="${BASE_URL%/Clash}/${rule}"
            category=$(echo "$rule" | cut -d'/' -f2)
            filename=$(basename "$rule")
            name="${filename%.txt}"
            
            echo "  Downloading: $category/$name"
            
            # ‰∏ãËΩΩÂéüÂßãÊñá‰ª∂
            if curl -sf "$url" -o "${category}/${filename}"; then
              # ËΩ¨Êç¢‰∏∫ YAML
              echo "payload:" > "yaml/${category}/${name}.yaml"
              grep -v '^#' "${category}/${filename}" | grep -v '^$' | sed 's/^/  - /' >> "yaml/${category}/${name}.yaml"
              
              # Â§çÂà∂‰∏∫ MRS
              cp "yaml/${category}/${name}.yaml" "mrs/${category}/${name}.mrs"
            fi
          done < rules_list.txt
          
          rm -f rules_list.txt
          
          echo "‚úÖ Done!"
          echo "üìä Statistics:"
          echo "  domainset: $(ls domainset/*.txt 2>/dev/null | wc -l) files"
          echo "  non_ip: $(ls non_ip/*.txt 2>/dev/null | wc -l) files"
          echo "  ip: $(ls ip/*.txt 2>/dev/null | wc -l) files"

      - name: Commit and Push
        run: |
          git add .
          if git diff-index --quiet HEAD --; then
            echo "No changes"
          else
            git commit -m "Sync: $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
          fi
