name: Sync Sukka Clash Rules

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Download and Convert Rules
        run: |
          BASE_URL="https://ruleset.skk.moe/Clash"
          
          # æ¸…ç†æ—§æ–‡ä»¶
          rm -rf domainset non_ip ip
          mkdir -p domainset non_ip ip
          
          # è·å–è§„åˆ™åˆ—è¡¨
          echo "ğŸ“¥ Fetching rule list..."
          curl -s https://ruleset.skk.moe/ | grep -oP 'Clash/(domainset|non_ip|ip)/[^"]+\.txt' | sort -u > /tmp/rules_list.txt
          
          # ä¸‹è½½å¹¶è½¬æ¢
          echo "ğŸ“¥ Downloading and converting rules..."
          while read -r rule; do
            url="${BASE_URL%/Clash}/${rule}"
            category=$(echo "$rule" | cut -d'/' -f2)
            filename=$(basename "$rule")
            name="${filename%.txt}"
            
            if curl -sf "$url" -o "/tmp/temp.txt"; then
              echo "  âœ… ${category}/${name}"
              
              # ç”Ÿæˆ YAML
              echo "payload:" > "${category}/${name}.yaml"
              grep -v '^#' "/tmp/temp.txt" | grep -v '^$' | sed 's/^/  - /' >> "${category}/${name}.yaml"
              
              # ç”Ÿæˆ MRSï¼ˆåŒå†…å®¹ï¼‰
              cp "${category}/${name}.yaml" "${category}/${name}.mrs"
            else
              echo "  âŒ ${category}/${name}"
            fi
          done < /tmp/rules_list.txt
          
          echo ""
          echo "âœ… Done!"
          echo "ğŸ“Š Statistics:"
          echo "  domainset: $(ls domainset/*.yaml 2>/dev/null | wc -l) rules"
          echo "  non_ip: $(ls non_ip/*.yaml 2>/dev/null | wc -l) rules"
          echo "  ip: $(ls ip/*.yaml 2>/dev/null | wc -l) rules"

      - name: Commit and Push
        run: |
          git add .
          if git diff-index --quiet HEAD --; then
            echo "No changes"
          else
            git commit -m "Sync: $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
          fi
