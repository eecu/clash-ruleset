name: Sync Sukka Clash Rules

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  MIHOMO_VERSION: 1.19.0

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install mihomo
        run: |
          curl -Lo mihomo.gz https://github.com/MetaCubeX/mihomo/releases/download/v${MIHOMO_VERSION}/mihomo-linux-amd64-v${MIHOMO_VERSION}.gz
          gzip -d mihomo.gz
          chmod +x mihomo
          sudo mv mihomo /usr/local/bin/
          mihomo -v

      - name: Download and Convert Rules
        run: |
          BASE_URL="https://ruleset.skk.moe/Clash"
          
          rm -rf domainset non_ip ip
          mkdir -p domainset non_ip ip
          
          echo "ğŸ“¥ Fetching rule list..."
          curl -s https://ruleset.skk.moe/ | grep -oP 'Clash/(domainset|non_ip|ip)/[^"]+\.txt' | sort -u > /tmp/rules_list.txt
          
          echo "ğŸ“¥ Downloading and converting rules..."
          while read -r rule; do
            url="${BASE_URL%/Clash}/${rule}"
            category=$(echo "$rule" | cut -d'/' -f2)
            filename=$(basename "$rule")
            name="${filename%.txt}"
            
            if curl -sf "$url" -o "/tmp/temp.txt"; then
              
              # æå–æœ‰æ•ˆè§„åˆ™ï¼ˆå»æ‰æ³¨é‡Šå’Œç©ºè¡Œï¼‰
              grep -v '^#' "/tmp/temp.txt" | grep -v '^$' | grep -v '^[[:space:]]*$' > /tmp/clean.txt
              
              # æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆè§„åˆ™
              rule_count=$(wc -l < /tmp/clean.txt)
              
              if [ "$rule_count" -gt 0 ]; then
                echo "  âœ… ${category}/${name} (${rule_count} rules)"
                
                # ç”Ÿæˆ YAML
                echo "payload:" > "${category}/${name}.yaml"
                sed 's/^/  - /' /tmp/clean.txt >> "${category}/${name}.yaml"
                
                # ç¡®å®š behavior
                if [ "$category" = "ip" ]; then
                  behavior="ipcidr"
                else
                  behavior="domain"
                fi
                
                # ç¼–è¯‘ MRS
                if ! mihomo convert-ruleset "$behavior" yaml "${category}/${name}.yaml" "${category}/${name}.mrs" 2>/dev/null; then
                  echo "  âš ï¸  ${category}/${name} MRS conversion failed, skipping MRS"
                  rm -f "${category}/${name}.mrs"
                fi
              else
                echo "  â­ï¸  ${category}/${name} (empty, skipped)"
              fi
            else
              echo "  âŒ ${category}/${name} (download failed)"
            fi
          done < /tmp/rules_list.txt
          
          echo ""
          echo "âœ… Done!"
          echo "ğŸ“Š Statistics:"
          echo "  domainset: $(ls domainset/*.yaml 2>/dev/null | wc -l) rules"
          echo "  non_ip: $(ls non_ip/*.yaml 2>/dev/null | wc -l) rules"
          echo "  ip: $(ls ip/*.yaml 2>/dev/null | wc -l) rules"

      - name: Commit and Push
        run: |
          git add .
          if git diff-index --quiet HEAD --; then
            echo "No changes"
          else
            git commit -m "Sync: $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
          fi
