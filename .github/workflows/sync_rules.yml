name: Sync Sukka Clash Rules

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  MIHOMO_VERSION: 1.19.0

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install mihomo
        run: |
          curl -Lo mihomo.gz https://github.com/MetaCubeX/mihomo/releases/download/v${MIHOMO_VERSION}/mihomo-linux-amd64-v${MIHOMO_VERSION}.gz
          gzip -d mihomo.gz
          chmod +x mihomo
          sudo mv mihomo /usr/local/bin/
          mihomo -v

      - name: Download and Convert Rules
        run: |
          set +e
          
          BASE_URL="https://ruleset.skk.moe/Clash"
          
          rm -rf domainset non_ip ip
          mkdir -p domainset non_ip ip
          
          echo "ğŸ“¥ Fetching rule list..."
          curl -s https://ruleset.skk.moe/ | grep -oP 'Clash/(domainset|non_ip|ip)/[^"]+\.txt' | sort -u > /tmp/rules_list.txt
          
          convert_to_mrs() {
            local yaml_file=$1
            local mrs_file=$2
            local behavior=$3
            local max_retries=3
            local retry=0
            
            while [ $retry -lt $max_retries ]; do
              if timeout 300 mihomo convert-ruleset "$behavior" yaml "$yaml_file" "$mrs_file" 2>/dev/null; then
                return 0
              fi
              ((retry++))
              echo "    Retry $retry/$max_retries..."
              sleep 2
            done
            return 1
          }
          
          echo "ğŸ“¥ Downloading and converting rules..."
          while read -r rule; do
            url="${BASE_URL%/Clash}/${rule}"
            category=$(echo "$rule" | cut -d'/' -f2)
            filename=$(basename "$rule")
            name="${filename%.txt}"
            
            # ä¸‹è½½
            if ! curl -sf --retry 3 "$url" -o "/tmp/temp.txt"; then
              echo "  âŒ ${category}/${name} (download failed)"
              continue
            fi
            
            # æ¸…ç†è§„åˆ™
            grep -v '^#' "/tmp/temp.txt" | grep -v '^$' | grep -v '^[[:space:]]*$' > /tmp/clean.txt
            rule_count=$(wc -l < /tmp/clean.txt)
            
            if [ "$rule_count" -eq 0 ]; then
              echo "  â­ï¸  ${category}/${name} (empty)"
              continue
            fi
            
            # ç”Ÿæˆ YAML
            echo "payload:" > "${category}/${name}.yaml"
            sed 's/^/  - /' /tmp/clean.txt >> "${category}/${name}.yaml"
            
            # ç¡®å®š behavior
            if [ "$category" = "ip" ]; then
              behavior="ipcidr"
            else
              behavior="domain"
            fi
            
            # ç¼–è¯‘ MRSï¼ˆå¸¦é‡è¯•å’Œè¶…æ—¶ï¼‰
            echo -n "  Processing ${category}/${name} (${rule_count} rules)... "
            if convert_to_mrs "${category}/${name}.yaml" "${category}/${name}.mrs" "$behavior"; then
              echo "âœ…"
            else
              echo "âš ï¸ MRS failed"
            fi
            
          done < /tmp/rules_list.txt
          
          echo ""
          echo "âœ… Done!"
          echo "ğŸ“Š Files generated:"
          echo "  domainset: $(ls domainset/*.yaml 2>/dev/null | wc -l) yaml, $(ls domainset/*.mrs 2>/dev/null | wc -l) mrs"
          echo "  non_ip: $(ls non_ip/*.yaml 2>/dev/null | wc -l) yaml, $(ls non_ip/*.mrs 2>/dev/null | wc -l) mrs"
          echo "  ip: $(ls ip/*.yaml 2>/dev/null | wc -l) yaml, $(ls ip/*.mrs 2>/dev/null | wc -l) mrs"

      - name: Commit and Push
        run: |
          git add .
          if git diff-index --quiet HEAD --; then
            echo "No changes"
          else
            git commit -m "Sync: $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
          fi
